# 2026-01-27 同步日志

## 基本信息
- **日期时间**: 2026-01-27 09:00-09:30
- **执行人**: Claude (AI Agent)
- **脚本版本**: sync_subtrees.sh (v1.0)

## 同步概况

### 主模块同步状态
- ✅ Atom01_hardware: 已是最新
- ✅ atom01_deploy: 同步完成（解决冲突）
- ✅ atom01_train: 同步完成
- ✅ atom01_description: 已是最新

### 子模块同步状态
- ✅ atom01_deploy/src/inference: 首次添加
- ✅ atom01_deploy/src/motors: 首次添加
- ✅ atom01_deploy/src/imu: 首次添加
- ✅ atom01_deploy/tools/create_ap: 首次添加
- ✅ atom01_train/robolab: 已是最新
- ✅ atom01_train/rsl_rl: 已是最新

## 遇到的问题

### 问题 1: atom01_deploy 目录结构重构冲突

**问题描述**:
```
CONFLICT (rename/delete): modules/atom01_deploy/create_ap renamed to modules/atom01_deploy/tools/create_ap in 86f4c8f1d2c082ee7b21b3ce6606c10e6714beef, but deleted in HEAD.
```

**根本原因**:
atom01_deploy 远程仓库进行了大规模目录重构：
- 子模块路径变更：
  - `inference` → `src/inference`
  - `motors` → `src/motors`
  - `imu` → `src/imu`
  - `create_ap` → `tools/create_ap`
- 资源文件移动：
  - `*.deb`, `*.rules`, `*.xml` → `assets/`
  - `start_robot.sh` → `tools/`
  - 新增 `scripts/` 目录

本地仓库使用旧结构的 subtree，与远程的新结构产生 rename/delete 冲突。

**解决步骤**:

1. **删除旧位置的 create_ap subtree**
   ```bash
   git rm -rf modules/atom01_deploy/create_ap
   git commit -m "移除旧的 create_ap subtree 子模块"
   ```

2. **接受远程重构并删除旧的子模块目录**
   ```bash
   git rm -rf modules/atom01_deploy/imu
   git rm -rf modules/atom01_deploy/inference
   git rm -rf modules/atom01_deploy/motors
   git commit -m "Merge atom01_deploy (重构目录结构)"
   ```

3. **删除合并产生的空 gitlink 目录**
   ```bash
   git rm -rf modules/atom01_deploy/src
   git commit -m "删除空的 src 目录"
   ```

4. **重新执行同步脚本**
   脚本自动在新位置添加子模块作为 subtree

**相关 Commits**:
- `05c1f3c` - 移除旧的 create_ap subtree 子模块
- `ef371ea` - Merge atom01_deploy (重构目录结构)
- `6da9bff` - 删除空的 src 目录
- `c5765d7` - Squashed 'modules/atom01_deploy/src/inference/'
- `d943abc` - Squashed 'modules/atom01_deploy/src/motors/'
- `89a5432` - Squashed 'modules/atom01_deploy/src/imu/'
- `27a034a` - Squashed 'modules/atom01_deploy/tools/create_ap/'

### 问题 2: subtree pull 失败

**问题描述**:
```
Can't squash-merge: 'modules/atom01_deploy/src/inference' was never added.
```

**根本原因**:
从远程合并的 `src/` 目录中的子模块是 gitlink (mode 160000)，不是 subtree 目录。脚本尝试使用 `git subtree pull` 更新它们，但这些目录从未通过 `git subtree add` 添加。

**解决方案**:
删除这些 gitlink 目录，让脚本在新位置重新添加为 subtree。

## 最终结果

### 同步状态
✅ **成功** - 所有模块和子模块已同步完成

### 新增文件
- 4 个子模块以 subtree 方式添加到新位置
- atom01_deploy 资源文件重组到 `assets/` 目录
- 新增示例脚本到 `scripts/` 目录

### 提交统计
- 本地分支领先 `origin/main` 16 个提交
- 工作区干净，无未提交更改

## 后续注意事项

1. **脚本改进点**:
   - 当前脚本的冲突处理逻辑主要针对 atom01_train
   - 对于目录重构等大规模变更，脚本无法自动处理
   - 建议未来增加对 gitlink 冲突的通用处理逻辑

2. **子模块路径变化**:
   - atom01_deploy 的子模块路径已更新，需更新相关依赖配置
   - 确保其他脚本或文档引用正确的路径

3. **定期同步**:
   - 建议定期执行同步以跟上上游更新
   - 大规模变更可能需要手动干预

## 附录

### .gitmodules 变更对比

**旧版本**:
```ini
[submodule "inference"]
    path = inference
    url = https://github.com/Luo1imasi/inference.git
[submodule "motors"]
    path = motors
    url = https://github.com/Luo1imasi/motors.git
[submodule "imu"]
    path = imu
    url = https://github.com/Luo1imasi/imu.git
[submodule "create_ap"]
    path = create_ap
    url = https://github.com/Luo1imasi/create_ap.git
```

**新版本**:
```ini
[submodule "inference"]
    path = src/inference
    url = https://github.com/Luo1imasi/inference.git
[submodule "motors"]
    path = src/motors
    url = https://github.com/Luo1imasi/motors.git
[submodule "imu"]
    path = src/imu
    url = https://github.com/Luo1imasi/imu.git
[submodule "create_ap"]
    path = tools/create_ap
    url = https://github.com/Luo1imasi/create_ap.git
```

### 修复建议

未来脚本可以增加以下功能：
1. 检测 .gitmodules 的变化，提示用户可能的手动干预
2. 自动识别大规模目录重构
3. 提供半自动模式，在遇到冲突时暂停并提供建议
